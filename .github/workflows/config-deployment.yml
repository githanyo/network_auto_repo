name: Config Test and Deploy

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allows manual triggering

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.9'

jobs:
  # Step 4: Testing Job
  test-config:
    name: Test Configuration Changes
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Run configuration validation
      run: |
        # Example: Validate YAML/JSON config files
        python scripts/validate_configs.py
        
    - name: Run syntax tests
      run: |
        # Example: Test any configuration syntax
        find . -name "*.yml" -exec yamllint {} \;
        find . -name "*.json" -exec python -m json.tool {} > /dev/null \;
    
    - name: Security scan
      uses: actions/codeql-analysis@v2
    
    - name: Notify test failure
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          github.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '❌ Configuration tests failed! Please check the workflow run.'
          })

  # Step 5: Deployment Jobs
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: test-config  # This job depends on test-config job
    if: github.ref == 'refs/heads/develop' || github.event_name == 'workflow_dispatch'
    
    environment: staging
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy to staging
      run: |
        # Example deployment script - customize for your needs
        ./deploy-scripts/deploy-staging.sh
        
    - name: Verify deployment
      run: |
        # Example: Verify the deployment worked
        curl -f https://staging.your-app.com/health || exit 1
        
    - name: Run integration tests
      run: |
        ./tests/integration-test.sh

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [test-config, deploy-staging]
    if: github.ref == 'refs/heads/main'
    
    environment: production
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy to production
      run: |
        ./deploy-scripts/deploy-production.sh
        
    - name: Verify production deployment
      run: |
        curl -f https://your-app.com/health || exit 1
        
    - name: Notify success
      uses: actions/github-script@v6
      with:
        script: |
          github.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '✅ Configuration successfully deployed to production!'
          })
